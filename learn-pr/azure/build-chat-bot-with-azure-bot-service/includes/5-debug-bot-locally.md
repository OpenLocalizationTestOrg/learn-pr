As with any application code that you write, changes to bot code need to be tested and debugged locally before being deployed to production. To help debug bots, Microsoft offers the Bot Framework Emulator. 

In this unit, you will learn how to use Visual Studio Code and the emulator to debug your bots.

## Install local Node.js packages

1. Execute the following command in Visual Studio Code's integrated terminal to install [Restify](http://restify.com/), a popular Node.js package for building and consuming RESTful web services:

    ```bash
    npm install restify
    ```

1. Repeat this step for the following commands to install the [Microsoft Bot Framework Bot Builder SDK for Node.js](https://docs.microsoft.com/bot-framework/nodejs/bot-builder-nodejs-quickstart):

    ```bash
    npm install botbuilder
    npm install botbuilder-azure
    npm install botbuilder-cognitiveservices
    ```

## Modify the Bot to execute locally with the Bot emulator

The downloaded code is a simple echo service. Let's replace that code with some basic code to ask questions and respond to simple prompts. We'll execute this code with the Bot emulator.

1. Select the **Explorer** button in Visual Studio Code's activity bar (it's the first icon in the sidebar).

1. Select **index.js** to open it in the code editor. This file contains the code that drives the bot â€” code that was generated by the Azure Bot Service and downloaded from the Azure portal.

1. Replace the contents of **index.js** with the following code, then save the file.

    ```JavaScript
    "use strict";
    var builder = require("botbuilder");
    var botbuilder_azure = require("botbuilder-azure");

    var useEmulator = true;
    var userName = "";
    var yearsCoding = "";
    var selectedLanguage = "";

    var connector = useEmulator ? new builder.ChatConnector() : new botbuilder_azure.BotServiceConnector({
        appId: process.env.MicrosoftAppId,
        appPassword: process.env.MicrosoftAppPassword
    });

    var bot = new builder.UniversalBot(connector);

    bot.dialog('/', [

    function (session) {
        builder.Prompts.text(session, "Hello, and welcome to QnA Factbot! What's your name?");
    },

    function (session, results) {
        userName = results.response;
        builder.Prompts.number(session, "Hi " + userName + ", how many years have you been writing code?");
    },

    function (session, results) {
        yearsCoding = results.response;
        builder.Prompts.choice(session, "What language do you love the most?", ["C#", "Python", "Node.js", "Visual FoxPro"]);
    },

    function (session, results) {
        selectedLanguage = results.response.entity;

        session.send("Okay, " + userName + ", I think I've got it:" +
            " You've been writing code for " + yearsCoding + " years," +
            " and prefer to use " + selectedLanguage + ".");
    }]);

    var restify = require('restify');
    var server = restify.createServer();

    server.listen(3978, function() {
        console.log('test bot endpoint at http://localhost:3978/api/messages');
    });

    server.post('/api/messages', connector.listen());
    ```

## Install the Bot Framework Emulator

The Bot Framework Emulator is a cross-platform desktop application that allows bot developers to test and debug bots built using the BotBuilder SDK.

You can use the Bot Framework Emulator to test bots running either locally on your machine or connect to bots running remotely through a secure network connection.

> [!NOTE]
> If you already have the emulator installed, you can skip this section and move on to debugging the Bot code.

1. Navigate to [Bot Framework Emulator releases page](https://github.com/Microsoft/BotFramework-Emulator/releases/) in a new browser tab or window.

1. Select a download for your specific platform, Linux, macOS, or Windows.
1. Unzip the package and install it through normal OS installation procedures.

## Debug the Bot in Visual Studio Code

Now that we have the emulator installed,

1. Switch back to Visual Studio Code and open the **index.js** source file.

1. Set breakpoints on lines 20, 25, and 30 (`builder.Prompts...` calls) by clicking in the margin on the left.

1. Select the **Debug** button in the activity bar, then select the green arrow **Start Debugging** button to start a debugging session.

1. Confirm that "test bot endpoint at <http://localhost:3978/api/messages>" appears in the debug console.

    ![Screenshot of Visual Studio Code showing the Debug system with the Debug navigation item and debug play button used to start a debugging session highlighted.](../media/5-vs-launch-debugger.png)

    Your bot code is now running locally.

1. Launch the **Bot Framework Emulator** from the Start Menu or launch icon.

1. Select the **Enter your endpoint URL** field. Enter the bot name and the bot URL `http://localhost:3978/api/messages` displayed in the debug console in the previous step.

1. Leave the Microsoft App ID, Microsoft App Password, and Locale fields empty and select **CONNECT**.

1. Then, select **Save and connect** and save the configuration file in the location of your choice.

    >[!TIP]
    > In the future, you can reconnect to the bot simply by selecting the bot name under "My Bots".

    ![Screenshot of the Bot Framework Emulator showing the New bot configuration screen with the Save and connect button highlighted.](../media/5-new-bot-configuration.png)

## Test the local bot

1. Type "hi" into the box at the bottom of the emulator and press <kbd>Enter</kbd>. Confirm that Visual Studio Code breaks on line 20 of **index.js**.

1. Select the **Continue** button in Visual Studio Code's debugging toolbar, and return to the emulator to see the bot's response.

1. The bot will ask you a series of questions. Answer them and select **Continue** in Visual Studio Code each time a breakpoint is hit. When you're done, select the **Stop** button in the debugging toolbar to end the debugging session.

At this point, you have a fully functioning bot and know how to debug it by running it locally in the Microsoft Bot Framework Emulator. The next step is to make the bot more intelligent by connecting it to the knowledge base you published.
